name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: '3.11'
  DOCKER_IMAGE_NAME: dataextraction

jobs:
  # 코드 품질 및 테스트
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov black flake8 mypy

      - name: Run linter (flake8)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: Check code formatting (black)
        run: |
          black --check .
        continue-on-error: true

      - name: Run tests
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          OPENSEARCH_HOST: localhost
          OPENSEARCH_PORT: 9200
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html
        continue-on-error: true

  # Docker 빌드 및 테스트
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        if: github.ref == 'refs/heads/main'
        run: |
          gcloud auth configure-docker --quiet

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.GCP_PROJECT_ID }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image to GCP Artifact Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Docker image (local test)
        if: github.ref != 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.DOCKER_IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker-compose up -d redis_cache
          sleep 5
          docker-compose build fastapi_server
          docker-compose up -d fastapi_server
          sleep 10
          curl -f http://localhost:8000/health || exit 1
          docker-compose down

  # Google Cloud Compute Engine 배포
  deploy:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/gcp_key
          chmod 600 ~/.ssh/gcp_key
          ssh-keyscan -H ${{ secrets.GCP_VM_EXTERNAL_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to GCP Compute Engine
        env:
          GCP_VM_USER: ${{ secrets.GCP_VM_USER }}
          GCP_VM_IP: ${{ secrets.GCP_VM_EXTERNAL_IP }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_ARTIFACT_REGISTRY: ${{ secrets.GCP_ARTIFACT_REGISTRY }}
          DOCKER_IMAGE_NAME: ${{ env.DOCKER_IMAGE_NAME }}
        run: |
          # 최신 이미지 태그 가져오기
          IMAGE_TAG=$(git rev-parse --short HEAD)
          IMAGE_URL="$GCP_PROJECT_ID-docker.pkg.dev/$GCP_PROJECT_ID/$GCP_ARTIFACT_REGISTRY/$DOCKER_IMAGE_NAME:main-$IMAGE_TAG"
          LATEST_IMAGE="$GCP_PROJECT_ID-docker.pkg.dev/$GCP_PROJECT_ID/$GCP_ARTIFACT_REGISTRY/$DOCKER_IMAGE_NAME:latest"
          
          # 배포 스크립트 생성
          cat > deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          IMAGE_URL="$1"
          LATEST_IMAGE="$2"
          PROJECT_ID="$3"
          REGISTRY="$4"
          IMAGE_NAME="$5"
          
          # 애플리케이션 디렉토리로 이동
          cd /opt/dataextraction 2>/dev/null || cd ~/dataextraction 2>/dev/null || cd /app 2>/dev/null || { echo "디렉토리를 찾을 수 없습니다"; exit 1; }
          
          # Docker 로그인
          gcloud auth configure-docker --quiet
          
          # 최신 이미지 pull
          echo "이미지 pull 중: $IMAGE_URL"
          docker pull "$IMAGE_URL" || docker pull "$LATEST_IMAGE" || echo "이미지 pull 실패, 로컬 빌드 사용"
          
          # docker-compose.yml이 있으면 이미지 참조 업데이트
          if [ -f docker-compose.yml ]; then
            # build 대신 image 사용하도록 변경 (선택적)
            if grep -q "build:" docker-compose.yml; then
              # build 섹션을 image로 변경하는 대신, image 필드 추가
              echo "docker-compose.yml에 이미지 참조 추가"
            fi
          fi
          
          # 기존 컨테이너 중지 및 제거
          echo "기존 컨테이너 중지 중..."
          docker-compose down || true
          
          # 새 컨테이너 시작
          echo "새 컨테이너 시작 중..."
          if docker images | grep -q "$IMAGE_NAME"; then
            # 이미지가 있으면 pull한 이미지 사용
            docker-compose up -d
          else
            # 이미지가 없으면 빌드
            docker-compose up -d --build
          fi
          
          # 헬스 체크
          echo "헬스 체크 중..."
          sleep 10
          for i in {1..5}; do
            if curl -f http://localhost:8000/health; then
              echo "배포 성공!"
              break
            else
              echo "헬스 체크 실패, 재시도 중... ($i/5)"
              sleep 5
            fi
          done
          
          # 오래된 이미지 정리 (선택적)
          docker image prune -f
          DEPLOY_SCRIPT
          
          # 스크립트를 VM에 복사하고 실행
          scp -i ~/.ssh/gcp_key -o StrictHostKeyChecking=no deploy.sh $GCP_VM_USER@$GCP_VM_IP:/tmp/deploy.sh
          ssh -i ~/.ssh/gcp_key -o StrictHostKeyChecking=no $GCP_VM_USER@$GCP_VM_IP "chmod +x /tmp/deploy.sh && /tmp/deploy.sh '$IMAGE_URL' '$LATEST_IMAGE' '$GCP_PROJECT_ID' '$GCP_ARTIFACT_REGISTRY' '$DOCKER_IMAGE_NAME'"

      - name: Verify deployment
        run: |
          sleep 5
          curl -f http://${{ secrets.GCP_VM_EXTERNAL_IP }}:8000/health || exit 1

