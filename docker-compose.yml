services:
  # 1. FastAPI 애플리케이션 서비스
  fastapi_server:
    container_name: dataextraction
    build: .
    # image: your-dockerhub-username/rag-query-analyzer:latest
    dns:
      - 8.8.8.8
      - 8.8.4.4
    # 포트 매핑: 호스트포트:컨테이너포트
    # API 문서에 따라 8000 포트를 사용합니다.
    ports:
      - "8000:8000"

    # .env 파일에서 환경 변수 로드 (파일이 없어도 에러 없이 진행)
    env_file:
      - .env

    # 환경 변수 설정 (Docker 네트워크 내부 서비스 이름으로 오버라이드)
    environment:
      # Redis 연결 정보 (Docker 네트워크 내부에서는 서비스 이름 사용)
      # Docker Compose 환경에서는 반드시 redis_cache 사용 (localhost가 아닌 서비스 이름)
      REDIS_HOST: redis_cache
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DECODE_RESPONSES: ${REDIS_DECODE_RESPONSES:-true}
      REDIS_CACHE_TTL: ${REDIS_CACHE_TTL:-3600}

      # OpenSearch 설정 (.env 파일에서 로드)
      OPENSEARCH_HOST: ${OPENSEARCH_HOST}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-9200}
      OPENSEARCH_USER: ${OPENSEARCH_USER:-admin}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD:-admin}
      OPENSEARCH_USE_SSL: ${OPENSEARCH_USE_SSL:-false}
      OPENSEARCH_VERSION: ${OPENSEARCH_VERSION:-2.11}

      # Qdrant 설정 (.env 파일에서 로드)
      QDRANT_HOST: ${QDRANT_HOST:-104.248.144.17}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}

      # Claude API 설정 (.env 파일에서 로드)
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      CLAUDE_MODEL: ${CLAUDE_MODEL:-claude-3-7-sonnet-latest}
      CLAUDE_MODEL_FAST: ${CLAUDE_MODEL_FAST:-claude-3-7-sonnet-latest}
      CLAUDE_MAX_TOKENS: ${CLAUDE_MAX_TOKENS:-1500}
      CLAUDE_TEMPERATURE: ${CLAUDE_TEMPERATURE:-0.1}

      # Embedding & Reranking 설정 (.env 파일에서 로드)
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-nlpai-lab/KURE-v1}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-1024}
      ENABLE_RERANKING: ${ENABLE_RERANKING:-true}
      RERANKER_MODELS: ${RERANKER_MODELS:-BAAI/bge-reranker-base,cross-encoder/ms-marco-MiniLM-L-12-v2}
      RERANK_TOP_K: ${RERANK_TOP_K:-5}

      # 벡터 검색 엔진 설정
      VECTOR_ENGINE: ${VECTOR_ENGINE:-nmslib}
      HNSW_EF_CONSTRUCTION: ${HNSW_EF_CONSTRUCTION:-128}
      HNSW_M: ${HNSW_M:-16}

      # 시스템 동작 설정
      APP_ENV: ${APP_ENV:-development}
      ENABLE_CACHE: ${ENABLE_CACHE:-true}
      CACHE_SIZE: ${CACHE_SIZE:-100}
      CACHE_SIMILARITY_THRESHOLD: ${CACHE_SIMILARITY_THRESHOLD:-0.95}
      ENABLE_ASYNC: ${ENABLE_ASYNC:-true}
      MAX_WORKERS: ${MAX_WORKERS:-4}
      MAX_REWRITTEN_QUERIES: ${MAX_REWRITTEN_QUERIES:-2}
      QUERY_LOG_FILE: ${QUERY_LOG_FILE:-query_performance.json}

      # 검색 파라미터 설정
      INITIAL_SEARCH_SIZE: ${INITIAL_SEARCH_SIZE:-50}
      FINAL_RESULT_SIZE: ${FINAL_RESULT_SIZE:-10}

      # Hugging Face 설정 (타임아웃 및 네트워크)
      HF_HUB_DOWNLOAD_TIMEOUT: ${HF_HUB_DOWNLOAD_TIMEOUT:-1200}
      TRANSFORMERS_VERBOSITY: ${TRANSFORMERS_VERBOSITY:-info}
      HF_HUB_DISABLE_TELEMETRY: ${HF_HUB_DISABLE_TELEMETRY:-1}

    # Redis 서비스에 의존함을 명시하여 Redis가 먼저 시작되도록 합니다.
    depends_on:
      - redis_cache

    restart: always

    networks:
      - rag_net

  # 2. Redis 캐싱 및 페이징 저장소 서비스
  redis_cache:
    container_name: rag_redis_cache
    image: redis:7.2-alpine

    ports:
      - "6379:6379"

    # Redis 안정성을 위한 설정
    # 손상된 RDB 파일 문제 해결: RDB 저장 비활성화하고 AOF만 사용
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
      --loglevel notice

    volumes:
      - redis_data:/data

    # 재시작 정책 변경: 실패 시에만 재시작 (무한 재시작 방지)
    restart: unless-stopped

    # 헬스 체크 추가
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

    networks:
      - rag_net

  # 3. Node Exporter (시스템 메트릭 수집: CPU, RAM, Disk 등)
  node_exporter:
    container_name: node_exporter
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    restart: unless-stopped
    networks:
      - rag_net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9100/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 4. Prometheus 메트릭 수집 서비스
  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    restart: unless-stopped
    networks:
      - rag_net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 5. Grafana 모니터링 대시보드 서비스
  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      # Grafana 기본 설정
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: ""
      # 서버 설정
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3000}
      GF_SERVER_SERVE_FROM_SUB_PATH: false
      # 데이터베이스 설정 (SQLite 사용, 프로덕션에서는 PostgreSQL 권장)
      GF_DATABASE_TYPE: sqlite3
      # 로그 설정
      GF_LOG_LEVEL: info
      # Provisioning 활성화
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    restart: unless-stopped
    networks:
      - rag_net
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  rag_net:
    driver: bridge

volumes:
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local