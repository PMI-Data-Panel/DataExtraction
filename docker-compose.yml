services:

  
  # ============================================
  # Redis (ë©”ì‹œì§€ ë¸Œë¡œì»¤ + ë°±ì—”ë“œ + ìºì‹œ)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: surveypilot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - surveypilot-network
    restart: unless-stopped
    # âœ…  ë©”ëª¨ë¦¬ ì œí•œ ì¶”ê°€ (OOM ë°©ì§€)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M


  fastapi-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: surveypilot-fastapi-server
    volumes:
      - ./:/app
    ports:
      - "8000:8000" # ì™¸ë¶€ í¬íŠ¸:ë‚´ë¶€ í¬íŠ¸
    environment:
      # ğŸ’¡  Celery Task í˜¸ì¶œì— í•„ìš”í•œ Redis ì„¤ì • (FastAPIê°€ Celeryë¥¼ í˜¸ì¶œí•  ë•Œ ì‚¬ìš©)
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - CACHE_DB=2
      # ğŸ’¡  OpenSearch/Qdrant ë“± ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²°ì„ ìœ„í•´ .env ë³€ìˆ˜ ì£¼ì…
      - OPENSEARCH_HOST=${OPENSEARCH_HOST}
      - QDRANT_HOST=${QDRANT_HOST}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy # Redisê°€ ì¤€ë¹„ëœ í›„ì— ì‹œì‘
    # ğŸ’¡  Uvicornì„ ì‚¬ìš©í•˜ì—¬ api/main_api.pyì˜ app ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤í–‰
    command: >
      uvicorn api.main_api:app
      --host 0.0.0.0
      --port 8000
    networks:
      - surveypilot-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2' # 1.0 -> 0.5 (4ì½”ì–´ì— ë§ì¶¤)
          memory: 2G
  # ============================================
  # ê³ ìš°ì„ ìˆœìœ„ Worker (ë‹¨ì¼ ì¸ë±ìŠ¤ ê²€ìƒ‰)
  # ============================================
  celery-worker-high: 
    
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    volumes:
      - ./:/app
      - ./logs:/app/logs
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - CACHE_DB=2
      - OPENSEARCH_HOST=${OPENSEARCH_HOST}
      - OPENSEARCH_PORT=${OPENSEARCH_PORT}
      - OPENSEARCH_USER=${OPENSEARCH_USER}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - PYTHONPATH=/app
      # âœ…  Worker ì‹ë³„ìš©
      - CELERY_WORKER_NAME=high-priority
      - LOAD_EMBEDDING_MODEL=True
    depends_on:
      redis:
        condition: service_healthy
    # âœ…  ìš°ì„ ìˆœìœ„ íë§Œ ì²˜ë¦¬ + ë™ì‹œì„± ì¦ê°€
    command: >
      celery -A redis_celery.celery_app worker
      --loglevel=info
      --concurrency=3
      --queues=search_high
      --pool=prefork
      --max-tasks-per-child=1000
      --hostname=high@%h
    networks:
      - surveypilot-network
    restart: unless-stopped
    # âœ…  í—¬ìŠ¤ì²´í¬ ì¶”ê°€
    healthcheck:
      test: ["CMD-SHELL", "celery -A redis_celery.celery_app inspect ping -d high@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # âœ…  ë¦¬ì†ŒìŠ¤ ì œí•œ
    deploy:
      replicas: 2  # âœ…  3ê°œ Workerë¡œ í™•ì¥
      resources:
        limits:
          cpus: '1.5'
          memory: 2.5G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ============================================
  # ì¤‘ê°„ìš°ì„ ìˆœìœ„ Worker (ì „ì²´ ê²€ìƒ‰ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)
  # ============================================
  celery-worker-medium:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    volumes:
      - ./:/app
      - ./logs:/app/logs
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - CACHE_DB=2
      - OPENSEARCH_HOST=${OPENSEARCH_HOST}
      - OPENSEARCH_PORT=${OPENSEARCH_PORT}
      - OPENSEARCH_USER=${OPENSEARCH_USER}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - PYTHONPATH=/app
      - CELERY_WORKER_NAME=medium-priority
    depends_on:
      redis:
        condition: service_healthy
    command: >
      celery -A redis_celery.celery_app worker
      --loglevel=info
      --concurrency=1
      --queues=search_medium
      --pool=prefork
      --max-memory-per-child=500000
      --max-tasks-per-child=1000
      --hostname=medium@%h
    networks:
      - surveypilot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "celery -A redis_celery.celery_app inspect ping -d medium@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.4'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
  # ============================================
  # ì €ìš°ì„ ìˆœìœ„ Worker (RRF ê²°í•© + ìºì‹±)
  # ============================================
  celery-worker-low:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    volumes:
      - ./:/app
      - ./logs:/app/logs
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - CACHE_DB=2
      - OPENSEARCH_HOST=${OPENSEARCH_HOST}
      - OPENSEARCH_PORT=${OPENSEARCH_PORT}
      - OPENSEARCH_USER=${OPENSEARCH_USER}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - PYTHONPATH=/app
      - CELERY_WORKER_NAME=low-priority
    depends_on:
      redis:
        condition: service_healthy
    command: >
      celery -A redis_celery.celery_app worker
      --loglevel=info
      --concurrency=1
      --queues=search_low
      --pool=prefork
      --max-memory-per-child=500000
      --max-tasks-per-child=1000
      --hostname=low@%h
    networks:
      - surveypilot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "celery -A redis_celery.celery_app inspect ping -d low@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
  # ============================================
  # Celery Beat (ìŠ¤ì¼€ì¤„ ì‘ì—… - í•„ìš”ì‹œë§Œ í™œì„±í™”)
  # ============================================
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: surveypilot-celery-beat
    env_file:
      - .env
    volumes:
      - ./:/app
      - ./logs:/app/logs
      - celerybeat-schedule:/app/celerybeat-schedule  # âœ…  ìŠ¤ì¼€ì¤„ ì˜ì†í™”
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - CACHE_DB=2
      - PYTHONPATH=/app
    depends_on:
      redis:
        condition: service_healthy
    command: >
      celery -A redis_celery.celery_app beat
      --loglevel=info
      --schedule=/app/celerybeat-schedule/celerybeat-schedule
    networks:
      - surveypilot-network
    restart: unless-stopped
    profiles:
      - with-beat  # âœ…  í•„ìš”ì‹œë§Œ: docker-compose --profile with-beat up
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================
  # Flower (Celery ëª¨ë‹ˆí„°ë§)
  # ============================================
  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: surveypilot-flower
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - PYTHONPATH=/app
      # âœ…  Flower ì¸ì¦ ì¶”ê°€ (í”„ë¡œë•ì…˜ í•„ìˆ˜)
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    depends_on:
      redis:
        condition: service_healthy
    command: >
      celery -A redis_celery.celery_app flower
      --port=5555
      --max_tasks=10000
      --persistent=True
      --db=/app/flower.db
    volumes:
      - ./:/app
      - flower-data:/app/flower.db  # âœ…  Flower ë°ì´í„° ì˜ì†í™”
    networks:
      - surveypilot-network
    restart: unless-stopped
    profiles:
      - with-flower
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5555/api/workers || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================
  # Redis Commander (Redis GUI - ê°œë°œìš©)
  # ============================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: surveypilot-redis-commander
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
      - HTTP_USER=${REDIS_COMMANDER_USER:-admin}
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD:-admin}
    depends_on:
      - redis
    networks:
      - surveypilot-network
    restart: unless-stopped
    profiles:
      - dev

  # ============================================
  # ë„¤íŠ¸ì›Œí¬
  # ============================================
networks:
  surveypilot-network:
    driver: bridge

# ============================================
# ë³¼ë¥¨
# ============================================
volumes:
  redis_data:
    driver: local
  celerybeat-schedule:  # âœ…  Beat ìŠ¤ì¼€ì¤„ ì˜ì†í™”
    driver: local
  flower-data:  # âœ…  Flower ë°ì´í„° ì˜ì†í™”
    driver: local